# Docker Setup for Citatum

This directory contains the Docker setup for the Citatum stack (FastAPI API, Celery workers, and monitoring).

## Services (docker-compose.yml)

- **FastAPI** (`fastapi`): Citatum API (Uvicorn)
- **Celery worker** (`celery-worker`) and **Celery beat** (`celery-beat`)
- **Flower** (`flower`): Celery monitoring UI
- **PostgreSQL + pgvector** (`postgres`)
- **RabbitMQ** (`rabbitmq`): Celery broker
- **Redis** (`redis`): Celery result backend/cache
- **Prometheus**, **Grafana**, **Node Exporter**, **Postgres Exporter** for metrics

## Setup Instructions

### 1) Create environment files

From the repo root:

```bash
cd docker/env
cp .env.example .env                # FastAPI & Celery app config (API keys, DB names, etc.)
cp .env.example.postgres .env.postgres
cp .env.example.redis .env.redis
cp .env.example.rabbitmq .env.rabbitmq
cp .env.example.grafana .env.grafana
cp .env.example.postgres-exporter .env.postgres-exporter
```

Edit each `.env` to set real secrets (API keys, passwords). The top-level `docker/.env` is loaded automatically by `docker compose` and can mirror `env/.env`.

### 2) Start the stack

```bash
cd docker
docker compose up --build -d
```

To start only specific services:

```bash
docker compose up -d postgres redis rabbitmq fastapi celery-worker
```

If you encounter connection issues, you may want to start the database services first and let them initialize before starting the application:

```bash
# Start data/backends first
docker compose up -d postgres redis rabbitmq postgres-exporter
# Wait for healthchecks
sleep 20
# Start application & monitoring
docker compose up -d fastapi celery-worker celery-beat flower prometheus grafana node-exporter
```

In case deleting all containers and volumes is necessary, you can run:

```bash
docker compose down -v --remove-orphans
```

### 3) Access the services

- API: http://localhost:8000
- Docs: http://localhost:8000/docs
- Flower: http://localhost:5555
- RabbitMQ UI: http://localhost:15672
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000
- Postgres Exporter: http://localhost:9187/metrics
- Node Exporter: http://localhost:9100/metrics

## Volume Management

### Managing Docker Volumes

Docker volumes are used to persist data generated by and used by Docker containers. Here are some commands to manage your volumes:

1. **List all volumes**:
   ```bash
   docker volume ls
   ```
2. **Inspect a volume**:

   ```bash
   docker volume inspect <volume_name>
   ```

   - list files in a volume:

   ```bash
   docker run --rm -v <volume_name>:/data busybox ls -l /data
   ```

3. **Remove a volume**:
   ```bash
   docker volume rm <volume_name>
   ```
4. **Prune unused volumes**:

   ```bash
    docker volume prune
   ```

5. **Backup volume for migration**:

   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine tar cvf /backup/backup.tar /volume
   ```

6. **Restore volume from backup**:

   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine sh -c "cd /volume && tar xvf /backup/backup.tar --strip 1"
   ```

7. **Remove all volumes**:
   ```bash
   docker volume rm $(docker volume ls -q)
   ```

**NOTE**: For PostgreSQL specifically, you might want to consider using PostgreSQL's built-in tools like `pg_dump` and `pg_restore` for more reliable backups, especially for live databases.

## Monitoring

### FastAPI Metrics

FastAPI is configured to expose Prometheus metrics at the `/metrics` endpoint. These metrics include:

- Request counts
- Request latencies
- Status codes

Prometheus is configured to scrape these metrics automatically.

### Visualizing Metrics in Grafana

1. Log into Grafana at http://localhost:3000 (default credentials: admin/admin_password)
2. Add Prometheus as a data source (URL: http://prometheus:9090)
3. Import dashboards for FastAPI, PostgreSQL, and Qdrant

#### Dashboards URLs

https://grafana.com/grafana/dashboards/18739-fastapi-observability/

https://grafana.com/grafana/dashboards/1860-node-exporter-full/

https://grafana.com/grafana/dashboards/23033-qdrant/

https://grafana.com/grafana/dashboards/12485-postgresql-exporter/

## Development Workflow

FastAPI runs with auto-reload in the container image; edits under `src/` hot-reload the API and Celery code.

## Troubleshooting

### Connection Errors

If you see connection errors when starting the services:

1. **Database Connection Refused**: This often happens when the FastAPI app tries to connect to databases before they're ready.

   ```
   Connection refused: [Errno 111] Connection refused
   ```

   Solutions:
   - Start database services first, wait, then start the application
   - Check database logs: `docker compose logs pgvector`
   - Ensure your database credentials in `.env.app` match those in `.env.postgres`

2. **Restart the FastAPI service** after databases are running:

   ```bash
   docker compose restart fastapi
   ```

3. **Check service status**:

   ```bash
   docker compose ps
   ```

4. **View logs** for more details:
   ```bash
   docker compose logs --tail=100 fastapi
   docker compose logs --tail=100 pgvector
   ```
